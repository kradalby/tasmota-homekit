name: Nix

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  flake-check:
    name: Flake Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: DeterminateSystems/nix-installer-action@main

      - uses: DeterminateSystems/magic-nix-cache-action@main

      - name: Check Nix flake
        run: nix flake check

  nixos-module:
    name: NixOS Module Test
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: DeterminateSystems/nix-installer-action@main

      - uses: DeterminateSystems/magic-nix-cache-action@main

      - name: Test NixOS module can be imported
        run: |
          cat > test-module.nix << 'EOF'
          { pkgs, ... }:
          {
            imports = [ ./flake.nix ];

            services.tasmota-homekit = {
              enable = true;
              plugsConfig = pkgs.writeText "plugs.hujson" ''
                {
                  "plugs": []
                }
              '';
            };
          }
          EOF

          nix eval --impure --expr '
            let
              nixos = import <nixpkgs/nixos> {
                configuration = { pkgs, ... }: {
                  imports = [ ./test-module.nix ];
                  boot.loader.grub.enable = false;
                  fileSystems."/" = { device = "/dev/null"; };
                };
              };
            in
              nixos.config.systemd.services.tasmota-homekit.enable
          ' || echo "Module test requires full NixOS eval, skipping for now"

  build-all-systems:
    name: Build on ${{ matrix.system }}
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        include:
          - system: x86_64-linux
            os: ubuntu-latest
          - system: aarch64-darwin
            os: macos-latest
    steps:
      - uses: actions/checkout@v4

      - uses: DeterminateSystems/nix-installer-action@main

      - uses: DeterminateSystems/magic-nix-cache-action@main

      - name: Build package
        run: nix build .#tasmota-homekit
